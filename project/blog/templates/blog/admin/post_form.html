
{% extends 'accounts/admin/admin_base.html' %}
{% load static %}

{% block title %}
    Rédiger un article | Gestion du blog
{% endblock %}

{% block admin_head %}
{{ form.media }}
<link rel="stylesheet" href="{% static 'css/global_forms.css' %}">
<link rel="stylesheet" href="{% static 'css/ck_editor.css' %}">
{% endblock %}

{% block admin_content %}

<!-- Modale de création de catégorie -->
{% include 'blog/admin/create_category_modal.html' %}

<section class="flex-1 bg-slate-900 flex flex-col py-12 md:py-20 w-full min-h-full">
    <div class="w-full max-w-[1080px] flex flex-col mx-auto px-2 sm:px-5">

        <!-- Header avec navigation -->
        <div class="relative mb-8">
            <!-- Retour Blog -->
            <a href="{% url 'blog:admin_index' %}" 
                class="absolute top-0 left-0 text-slate-300 hover:text-cyan-400 flex gap-3 hover:gap-5 items-center transition-all duration-300 ease-in-out text-sm group">
                <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform duration-300"></i>
                <span>Retour au blog</span>
            </a>
            
            <!-- Titre Principal -->
            <div class="text-center pt-12">
                <p class="text-orange-400 text-sm md:text-base lg:text-lg uppercase font-light mb-2 md:mb-4">
                    Gestion du Blog - Rédaction
                </p>
                <h1 class="text-[40px] sm:text-[50px] md:text-[70px] lg:text-[100px] uppercase my-0 font-extrabold mb-4 leading-tight font-story drop-shadow-md 
                flex flex-col md:flex-row justify-center">
                    <span class="bg-gradient-to-b from-cyan-400 from-30% px-1 sm:px-2 md:px-3
                    to-blue-500 bg-clip-text text-transparent">
                        Gestion
                    </span>
                    <span class="bg-gradient-to-r from-orange-600 via-orange-500 px-1 sm:px-2 md:px-3 -mt-2 sm:-mt-3 md:-mt-4 lg:-mt-0
                    to-yellow-500 bg-clip-text text-transparent">
                        Blog
                    </span>
                </h1>
            </div>
        </div>

        <!-- Form Container -->
        <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-3xl p-2 md:p-8 shadow-lg">
            <form method="post" class="flex flex-col gap-6" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Erreurs globales -->
                {% if form.errors %}
                <div class="bg-red-500/10 backdrop-blur-sm border border-red-500/30 rounded-2xl p-4 mb-6">
                    <h3 class="text-red-300 font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        Erreurs détectées :
                    </h3>
                    <ul class="space-y-2">
                        {% for field in form %}
                            {% if field.errors %}
                                <li class="text-red-200 text-sm">
                                    <strong>{{ field.label }} :</strong> {{ field.errors|join:", " }}
                                </li>
                            {% endif %}
                        {% endfor %}
                        {% if form.non_field_errors %}
                            <li class="text-red-200 text-sm">{{ form.non_field_errors|join:", " }}</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}

                <!-- Titre de l'article -->
                <div class="space-y-2">
                    <label for="{{ form.title.id_for_label }}" class="text-slate-200 font-semibold flex items-center gap-2">
                        <i class="fas fa-heading text-orange-400"></i>
                        Titre de l'article
                    </label>
                    {{ form.title }}
                </div>

                <!-- Slug -->
                <div class="space-y-2">
                    <label for="{{ form.slug.id_for_label }}" class="text-slate-200 font-semibold flex items-center gap-2">
                        <i class="fas fa-link text-cyan-400"></i>
                        URL (Slug)
                    </label>
                    {{ form.slug }}
                    <p class="text-slate-400 text-sm">URL friendly de l'article (généré automatiquement si vide)</p>
                </div>

                <!-- Introduction -->
                <div class="space-y-2">
                    <label for="{{ form.introduction.id_for_label }}" class="text-slate-200 font-semibold flex items-center gap-2">
                        <i class="fas fa-quote-left text-blue-400"></i>
                        Introduction
                    </label>
                    {{ form.introduction }}
                    <p class="text-slate-400 text-sm">Résumé qui apparaîtra sur la page d'accueil et dans les partages</p>
                </div>

                <!-- Image de couverture -->
                <div class="space-y-4" id="thumbnail-container">
                    <label class="text-slate-200 font-semibold flex items-center gap-2">
                        <i class="fas fa-image text-purple-400"></i>
                        Image de couverture
                    </label>
                    
                    <!-- Aperçu de l'image -->
                    <div id="image-preview" class="hidden bg-slate-700/50 rounded-2xl p-4 border border-slate-600/50">
                        <img id="preview-img" src="" alt="Aperçu" class="max-w-[400px] mx-auto rounded-xl shadow-lg">
                    </div>
                    
                    <!-- Zone de drop/upload stylée -->
                    <div class="relative">
                        <label for="{{ form.thumbnail.id_for_label }}" class="group cursor-pointer block">
                            <div class="bg-slate-700/50 border-2 border-dashed border-slate-600 hover:border-purple-500/50 rounded-2xl p-8 text-center transition-all duration-300 group-hover:bg-slate-700/70">
                                <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                    <i class="fas fa-upload text-white text-2xl"></i>
                                </div>
                                <p class="text-slate-300 font-semibold mb-2" id="upload-text">Cliquez pour choisir une image</p>
                                <p class="text-slate-500 text-sm">PNG, JPG, WEBP jusqu'à 5MB</p>
                            </div>
                        </label>
                        
                        <!-- Input caché -->
                        <div class="absolute -top-full opacity-0 pointer-events-none">
                            {{ form.thumbnail }}
                        </div>
                    </div>
                    
                    <!-- Nom du fichier sélectionné -->
                    <div id="file-info" class="hidden bg-slate-700/30 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-file-image text-purple-400"></i>
                            <span id="file-name" class="text-slate-300 font-medium"></span>
                            <button type="button" id="remove-file" class="ml-auto text-red-400 hover:text-red-300 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Légende de l'image -->
                <div class="space-y-2">
                    <label for="{{ form.thumbnail_caption.id_for_label }}" class="text-slate-200 font-semibold flex items-center gap-2">
                        <i class="fas fa-comment-alt text-gray-400"></i>
                        Légende de l'image
                    </label>
                    {{ form.thumbnail_caption }}
                </div>

                <!-- Catégories -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="text-slate-200 font-semibold flex items-center gap-2">
                            <i class="fas fa-tags text-green-400"></i>
                            Catégories
                        </label>
                        <button type="button" id="open_category_modal" class="bg-green-500/20 hover:bg-green-500/30 text-green-300 px-4 py-2 rounded-xl transition-all duration-300 flex items-center gap-2 text-sm">
                            <i class="fas fa-plus"></i>
                            Nouvelle catégorie
                        </button>
                    </div>
                    
                    <div class="bg-slate-700/30 rounded-2xl p-6">
                        {{ form.categories }}
                    </div>
                </div>

                <!-- Contenu de l'article -->
                <div class="space-y-4">
                    <label for="{{ form.content.id_for_label }}" class="text-slate-200 font-semibold flex items-center gap-2">
                        <i class="fas fa-edit text-yellow-400"></i>
                        Contenu de l'article
                    </label>
                    <div class="bg-slate-700/30 rounded-2xl p-4">
                        {{ form.content }}
                    </div>
                </div>

                <!-- Options de publication -->
                <div class="bg-slate-700/30 rounded-2xl p-6 space-y-4">
                    <h3 class="text-slate-200 font-semibold flex items-center gap-2 mb-4">
                        <i class="fas fa-cog text-slate-400"></i>
                        Options de publication
                    </h3>
                    
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 cursor-pointer">
                            {{ form.published }}
                            <span class="text-slate-300">Publier l'article immédiatement</span>
                        </label>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="flex flex-col sm:flex-row gap-4 pt-6">
                    <button type="submit" name="action" value="save" class="group relative bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl shadow-orange-800/50 hover:shadow-orange-800/90 overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative flex items-center justify-center">
                            <i class="fas fa-save mr-3 text-xl"></i>
                            <span>Enregistrer l'article</span>
                        </div>
                    </button>
                    
                    <button type="submit" name="action" value="preview" class="group relative bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl shadow-blue-800/50 hover:shadow-blue-800/90 overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative flex items-center justify-center">
                            <i class="fas fa-eye mr-3 text-xl"></i>
                            <span>Prévisualiser</span>
                        </div>
                    </button>
                    
                    <a href="{% url 'blog:admin_index' %}" class="bg-slate-600/50 hover:bg-slate-600/70 text-slate-300 
                    hover:text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 text-center flex gap-3 items-center justify-center">
                        <i class="fas fa-right-to-bracket"></i>
                        Annuler
                    </a>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
// Script pour gérer l'upload d'image
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('{{ form.thumbnail.id_for_label }}');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const removeBtn = document.getElementById('remove-file');
    const uploadText = document.getElementById('upload-text');

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.classList.remove('hidden');
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');
                uploadText.textContent = 'Image sélectionnée - Cliquez pour changer';
            };
            reader.readAsDataURL(file);
        }
    });

    removeBtn.addEventListener('click', function() {
        fileInput.value = '';
        imagePreview.classList.add('hidden');
        fileInfo.classList.add('hidden');
        uploadText.textContent = 'Cliquez pour choisir une image';
    });

    // Gérer les clics sur les catégories existantes
    const categoryLabels = document.querySelectorAll('#id_categories label');
    categoryLabels.forEach(label => {
        label.addEventListener('click', function(e) {
            e.preventDefault();
            const checkbox = document.getElementById(label.getAttribute('for'));
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateCategoryLabel(label, checkbox.checked);
            }
        });
        
        // Initialiser l'état visuel des catégories existantes
        const checkbox = document.getElementById(label.getAttribute('for'));
        if (checkbox) {
            updateCategoryLabel(label, checkbox.checked);
        }
    });
});

// Fonction pour mettre à jour l'apparence du label
function updateCategoryLabel(label, isChecked) {
    if (isChecked) {
        label.classList.add('selected');
    } else {
        label.classList.remove('selected');
    }
}

// Fonction globale pour ajouter une nouvelle catégorie (utilisée par le modal)
window.addCategoryToForm = function(categoryData) {
    const categoryGrid = document.getElementById('id_categories');
    if (!categoryGrid) return;

    // Créer un nouveau div pour la catégorie
    const newCategoryDiv = document.createElement('div');
    
    // Créer la checkbox
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'categories';
    checkbox.value = categoryData.id;
    checkbox.id = `id_categories_${categoryData.id}`;
    checkbox.checked = true; // Nouvelle catégorie sélectionnée par défaut
    
    // Créer le label
    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.textContent = categoryData.name;
    label.classList.add('selected'); // Style sélectionné
    
    // Ajouter l'événement click au label
    label.addEventListener('click', function(e) {
        e.preventDefault();
        checkbox.checked = !checkbox.checked;
        updateCategoryLabel(label, checkbox.checked);
    });
    
    // Assembler les éléments
    newCategoryDiv.appendChild(checkbox);
    newCategoryDiv.appendChild(label);
    categoryGrid.appendChild(newCategoryDiv);
};
</script>

{% endblock %}
 

{% block admin_scripts %}
<script src="{% static 'js/global_forms.js' %}"></script>
<script src="{% static 'js/create_category_modal.js' %}"></script>
{% endblock %}
